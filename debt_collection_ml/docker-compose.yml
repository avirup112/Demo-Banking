version: '3.8'

services:
  # MLflow Tracking Server
  mlflow:
    image: python:3.9-slim
    container_name: debt_collection_mlflow
    ports:
      - "5000:5000"
    volumes:
      - ./mlruns:/mlruns
      - ./models:/models
    working_dir: /app
    command: >
      bash -c "
        pip install mlflow==2.5.0 &&
        mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri file:///mlruns --default-artifact-root file:///models
      "
    environment:
      - MLFLOW_TRACKING_URI=http://localhost:5000
    networks:
      - debt_collection_network

  # Main ML Application
  ml-app:
    build: .
    container_name: debt_collection_ml_app
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./logs:/app/logs
      - ./reports:/app/reports
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - PYTHONPATH=/app/src
    depends_on:
      - mlflow
    networks:
      - debt_collection_network
    command: >
      bash -c "
        python scripts/train_model_pipeline.py --optimize &&
        python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000
      "

  # Streamlit Dashboard
  dashboard:
    build: .
    container_name: debt_collection_dashboard
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./reports:/app/reports
    environment:
      - PYTHONPATH=/app/src
    depends_on:
      - ml-app
    networks:
      - debt_collection_network
    command: streamlit run src/visualization/dashboard.py --server.port=8501 --server.address=0.0.0.0

  # Monitoring Service
  monitoring:
    build: .
    container_name: debt_collection_monitoring
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./monitoring:/app/monitoring
    environment:
      - PYTHONPATH=/app/src
    depends_on:
      - ml-app
    networks:
      - debt_collection_network
    command: >
      bash -c "
        while true; do
          python scripts/monitoring_pipeline.py
          sleep 3600
        done
      "

  # Jupyter Notebook Server
  jupyter:
    build: .
    container_name: debt_collection_jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/app/notebooks
      - ./data:/app/data
      - ./src:/app/src
      - ./models:/app/models
    environment:
      - PYTHONPATH=/app/src
    networks:
      - debt_collection_network
    command: >
      bash -c "
        pip install jupyter &&
        jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''
      "

networks:
  debt_collection_network:
    driver: bridge

volumes:
  mlruns:
  models:
  data:
  logs:
  reports:
  monitoring: